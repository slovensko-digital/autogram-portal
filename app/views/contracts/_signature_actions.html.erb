<%# locals: (info_hidden: false, no_preview: false, contract:) %>

<% if contract.awaiting_signature? %>
  <% content_for :head do %>
    <script src="<%= asset_path('autogram-sdk.js') %>"></script>
    <script>
      // Device detection for proper button visibility
      document.addEventListener('DOMContentLoaded', function() {
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                        ('ontouchstart' in window) || 
                        (navigator.maxTouchPoints > 0);
        
        const desktopElements = document.querySelectorAll('.desktop-signing-element');
        desktopElements.forEach(element => {
          if (isMobile) {
            element.style.display = 'none';

            const autogramRadio = element.querySelector('input[value="autogram"]');
            const avmRadio = document.querySelector('input[value="avm"]');
            if (autogramRadio && autogramRadio.checked && avmRadio) {
              autogramRadio.checked = false;
              avmRadio.checked = true;
            }
          } else {
            element.style.display = 'block';
          }
        });
      });
    </script>
  <% end %>

  <div id="signature_actions_<%= contract.uuid %>" data-controller="signature-method-selector">
    <div class="mb-4">              
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-3">Select signing application</label>
        <div class="space-y-3">
          <%= render 'shared/radio_button_card',
                name: "signature_method_#{contract.uuid}",
                value: 'autogram',
                label: 'Autogram Desktop',
                description: 'Desktop application with qualified electronic seal or chip ID card',
                checked: true,
                wrapper_class: 'desktop-signing-element',
                data_attributes: { 
                  signature_method_selector_target: 'methodRadio'
                } %>

          <%= render 'shared/radio_button_card',
                name: "signature_method_#{contract.uuid}",
                value: 'avm',
                label: 'Autogram Mobile',
                description: 'Mobile app or web interface - scan QR code or open AVM app directly',
                checked: false,
                data_attributes: { 
                  signature_method_selector_target: 'methodRadio'
                } %>
        </div>
      </div>
    </div>

    <div class="space-y-3" data-signature-method-selector-target="buttonContainer">
      <div data-controller="document-signer" 
          data-document-signer-use-timestamp-value="false"
          data-document-signer-contract-param-value="<%= contract_path(contract) %>"
          data-signature-method-selector-target="signerController autogramForm"
          class="hidden">
        <%= form_with url: sign_contract_path(contract), method: :post, 
                      class: "w-full",
                      data: { 
                        "document-signer-target": "form",
                        action: "submit->document-signer#signAutogram"
                      } do |form| %>
          <button type="submit" 
                  data-document-signer-target="submitButton"
                  style="display: none;">
          </button>
        <% end %>
      </div>

      <%= form_with url: sign_avm_contract_path(contract), method: :post, 
                    class: "w-full hidden",
                    local: false,
                    data: { 
                      controller: "avm-signer",
                      "signature-method-selector-target": "avmForm"
                    } do |form| %>
        <% if no_preview %>
          <%= form.hidden_field :no_preview, value: "1" %>
        <% end %>
        <button type="submit" 
                data-avm-signer-target="button"
                data-action="click->avm-signer#handleClick"
                style="display: none;">
        </button>
      <% end %>

      <button type="button"
              data-signature-method-selector-target="signButton"
              data-action="click->signature-method-selector#triggerSign"
              class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
        Sign
      </button>
    </div>
  </div>
<% else %>
  <div class="bg-green-50 border border-green-200 rounded-lg p-6 ">
    <h3 class="text-lg font-semibold text-green-800">Documents have been signed</h3>
    <div class="text-green-700">
      <p class="mb-3">
        This contract has been signed and is complete. No further signature is required.
      </p>
    </div>
  </div>
<% end %>
